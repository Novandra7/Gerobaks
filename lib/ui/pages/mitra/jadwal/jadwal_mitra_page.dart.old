import 'package:bank_sha/services/local_storage_service.dart';
import 'package:bank_sha/shared/theme.dart';
import 'package:bank_sha/ui/widgets/gerobaks_components.dart';
import 'package:bank_sha/utils/map_utils.dart';
import 'package:bank_sha/utils/responsive_helper.dart';
import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import 'package:intl/date_symbol_data_local.dart';

class JadwalMitraPage extends StatefulWidget {
  const JadwalMitraPage({super.key});

  @override
  State<JadwalMitraPage> createState() => _JadwalMitraPageState();
}

class _JadwalMitraPageState extends State<JadwalMitraPage> {
  bool _isLoading = false;
  String _selectedFilter = 'semua'; // Filter options: semua, pending, in_progress, completed
  final MapController _mapController = MapController();
  int _selectedCardIndex = -1; // Index of the selected schedule card
  final PageController _pageController = PageController(initialPage: 0, viewportFraction: 0.9);
  final TextEditingController _searchController = TextEditingController();
  
  // Service area polygon coordinates
  final List<LatLng> _serviceAreaPolygon = [
    LatLng(-0.502473, 117.148738),
    LatLng(-0.503042, 117.148523),
    LatLng(-0.503959, 117.151090),
    LatLng(-0.503240, 117.151347),
  ];
  
  // Initial map center position
  final LatLng _mapCenter = LatLng(-0.5035, 117.1500);
  
  // Mock schedules data - in a real app, this would come from an API
  final List<Map<String, dynamic>> _schedules = [
    {
      'id': '1',
      'customer_name': 'Wahyu Indra',
      'address': 'JL. Muso Salim B No. 28, RT 15, Samarinda Utara',
      'status': 'pending',
      'time': '14:00 - 16:00',
      'coordinates': LatLng(-0.502784, 117.149304),
      'waste_type': 'Organik',
      'waste_weight': '3.5 kg'
    },
    {
      'id': '2',
      'customer_name': 'Budi Santoso',
      'address': 'JL. Kesuma Bangsa No. 45, RT 15, Samarinda Utara',
      'status': 'in_progress',
      'time': '10:00 - 12:00',
      'coordinates': LatLng(-0.503584, 117.150204),
      'waste_type': 'Anorganik',
      'waste_weight': '2.1 kg'
    },
    {
      'id': '3',
      'customer_name': 'Ratna Dewi',
      'address': 'JL. Perjuangan No. 12, RT 15, Samarinda Utara',
      'status': 'completed',
      'time': '08:00 - 10:00',
      'coordinates': LatLng(-0.501984, 117.148504),
      'waste_type': 'Organik',
      'waste_weight': '4.2 kg'
    },
  ];

  @override
  void initState() {
    super.initState();
    _initialize();
  }
  
  @override
  void dispose() {
    _searchController.dispose();
    _pageController.dispose();
    super.dispose();
  }
  
  Future<void> _initialize() async {
    setState(() {
      _isLoading = true;
    });
    
    try {
      await initializeDateFormatting('id_ID', null);
      
      // In a real app, this would fetch schedules from the API
      // await _fetchSchedulesFromApi();
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Gagal memuat jadwal: $e'),
            backgroundColor: Colors.red,
            behavior: SnackBarBehavior.floating,
            margin: const EdgeInsets.only(
              left: 16, 
              right: 16, 
              bottom: 80
            ),
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }
  
  // Get filtered schedules based on current filter
  List<Map<String, dynamic>> _getFilteredSchedules() {
    if (_selectedFilter == 'semua') {
      return _schedules;
    } else {
      return _schedules.where((schedule) => schedule['status'] == _selectedFilter).toList();
    }
  }
  
  // Open external map navigation
  void _navigateToLocation(LatLng location) {
    MapUtils.openMapsNavigation(
      latitude: location.latitude,
      longitude: location.longitude,
    );
  }

  // Focus map on selected schedule
  void _focusOnSelectedSchedule(Map<String, dynamic> schedule) {
    final coordinates = schedule['coordinates'] as LatLng;
    _mapController.move(coordinates, 16.0);
  }

  // Build markers for the map
  List<Marker> _buildMarkers(List<Map<String, dynamic>> schedules) {
    return schedules.asMap().entries.map((entry) {
      final index = entry.key;
      final schedule = entry.value;
      final coordinates = schedule['coordinates'] as LatLng;
      
      return Marker(
        width: 40.0,
        height: 40.0,
        point: coordinates,
        child: GestureDetector(
          onTap: () {
            setState(() {
              _selectedCardIndex = index;
              _pageController.animateToPage(
                index,
                duration: const Duration(milliseconds: 300),
                curve: Curves.easeInOut,
              );
            });
          },
          child: Container(
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: _selectedCardIndex == index ? greenColor : Colors.white,
              border: Border.all(
                color: greenColor,
                width: 2,
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 6,
                  offset: const Offset(0, 3),
                ),
              ],
            ),
            child: Center(
              child: Icon(
                Icons.location_on,
                color: _selectedCardIndex == index ? Colors.white : greenColor,
                size: 24,
              ),
            ),
          ),
        ),
      );
    }).toList();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: lightBackgroundColor,
      body: Column(
        children: [
          // Header using reusable component
          GerobaksHeader(
            title: 'Jadwal Pengambilan',
            extraContent: [
              // Vehicle and Driver ID info
              Padding(
                padding: EdgeInsets.symmetric(
                  horizontal: ResponsiveHelper.getResponsiveSpacing(context, 16)
                ),
                child: Row(
                  children: [
                    Icon(
                      Icons.local_shipping_outlined, 
                      color: Colors.white.withOpacity(0.9),
                      size: ResponsiveHelper.getResponsiveIconSize(context, 16),
                    ),
                    SizedBox(width: ResponsiveHelper.getResponsiveSpacing(context, 6)),
                    Text(
                      'KT 777 WAN', 
                      style: whiteTextStyle.copyWith(
                        fontSize: ResponsiveHelper.getResponsiveFontSize(context, 13),
                        fontWeight: medium,
                      ),
                    ),
                    SizedBox(width: ResponsiveHelper.getResponsiveSpacing(context, 16)),
                    Icon(
                      Icons.badge_outlined, 
                      color: Colors.white.withOpacity(0.9),
                      size: ResponsiveHelper.getResponsiveIconSize(context, 16),
                    ),
                    SizedBox(width: ResponsiveHelper.getResponsiveSpacing(context, 6)),
                    Text(
                      'DRV-KTM-214', 
                      style: whiteTextStyle.copyWith(
                        fontSize: ResponsiveHelper.getResponsiveFontSize(context, 13),
                        fontWeight: medium,
                      ),
                    ),
                  ],
                ),
              ),
              
              SizedBox(height: ResponsiveHelper.getResponsiveSpacing(context, 16)),
              
              // RT 15 Badge
              IconBadge(
                icon: Icons.location_on,
                text: 'RT 15',
                backgroundColor: Colors.white.withOpacity(0.2),
                iconColor: Colors.white,
                textColor: Colors.white,
              ),
            ],
          ),
          
          // Search field using reusable component
          CoordinatesSearchField(
            controller: _searchController,
            onNavigateTap: () {
              // Implement search location navigation
            },
            onFilterTap: () {
              // Show filter options
            },
          ),
          
          // Body content with fullscreen map
          Expanded(
            child: _isLoading 
              ? Center(child: CircularProgressIndicator(color: greenColor))
              : _buildFullscreenMapView(),
          ),
        ],
      ),
    );
  }
  
  // Fullscreen map view with floating components
  Widget _buildFullscreenMapView() {
    final schedules = _getFilteredSchedules();
    
    return Stack(
      children: [
        // Map base
        SizedBox(
          width: double.infinity,
          height: double.infinity,
          child: FlutterMap(
            mapController: _mapController,
            options: MapOptions(
              initialCenter: _mapCenter,
              initialZoom: 16.0,
              onTap: (_, __) {
                // Clear selection when tapping outside markers
                setState(() {
                  _selectedCardIndex = -1;
                });
              },
            ),
            children: [
              // Base map layer
              TileLayer(
                urlTemplate: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                subdomains: const ['a', 'b', 'c', 'd'],
                userAgentPackageName: 'com.gerobaks.app',
              ),
              
              // Service area polygon
              PolygonLayer(
                polygons: [
                  Polygon(
                    points: _serviceAreaPolygon,
                    color: greenColor.withOpacity(0.2),
                    borderColor: greenColor,
                    borderStrokeWidth: 2,
                  ),
                ],
              ),
              
              // Pickup location markers
              MarkerLayer(
                markers: _buildMarkers(schedules),
              ),
            ],
          ),
        ),
        
        // Filter tabs
        Positioned(
          top: ResponsiveHelper.getResponsiveHeight(context, 16),
          left: 0,
          right: 0,
          child: Container(
            margin: EdgeInsets.symmetric(
              horizontal: ResponsiveHelper.getResponsiveSpacing(context, 16)
            ),
            padding: EdgeInsets.symmetric(
              horizontal: ResponsiveHelper.getResponsiveSpacing(context, 8),
              vertical: ResponsiveHelper.getResponsiveSpacing(context, 4),
            ),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(
                ResponsiveHelper.getResponsiveRadius(context, 8)
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: Row(
              children: [
                FilterTabButton(
                  title: 'Semua', 
                  isSelected: _selectedFilter == 'semua', 
                  onTap: () {
                    setState(() {
                      _selectedFilter = 'semua';
                    });
                  }
                ),
                FilterTabButton(
                  title: 'Menunggu', 
                  isSelected: _selectedFilter == 'pending', 
                  onTap: () {
                    setState(() {
                      _selectedFilter = 'pending';
                    });
                  }
                ),
                FilterTabButton(
                  title: 'Diproses', 
                  isSelected: _selectedFilter == 'in_progress', 
                  onTap: () {
                    setState(() {
                      _selectedFilter = 'in_progress';
                    });
                  }
                ),
                FilterTabButton(
                  title: 'Selesai', 
                  isSelected: _selectedFilter == 'completed', 
                  onTap: () {
                    setState(() {
                      _selectedFilter = 'completed';
                    });
                  }
                ),
              ],
            ),
          ),
        ),
        
        // Prioritas Terdekat label
        Positioned(
          top: ResponsiveHelper.getResponsiveHeight(context, 80),
          left: 0,
          right: 0,
          child: Padding(
            padding: EdgeInsets.symmetric(
              horizontal: ResponsiveHelper.getResponsiveSpacing(context, 16)
            ),
            child: Row(
              children: [
                Container(
                  width: 4,
                  height: 16,
                  decoration: BoxDecoration(
                    color: greenColor,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
                SizedBox(width: 8),
                Text(
                  'Prioritas Terdekat',
                  style: blackTextStyle.copyWith(
                    fontSize: ResponsiveHelper.getResponsiveFontSize(context, 16),
                    fontWeight: semiBold,
                  ),
                ),
              ],
            ),
          ),
        ),
        
        // Floating schedule cards at bottom with left/right navigation
        Positioned(
          bottom: ResponsiveHelper.getResponsiveSpacing(context, 16),
          left: 0,
          right: 0,
          child: Column(
            children: [
              // Schedule card navigation
              if (schedules.isNotEmpty) ...[
                Padding(
                  padding: EdgeInsets.symmetric(
                    horizontal: ResponsiveHelper.getResponsiveSpacing(context, 16)
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      // Left navigation button
                      NavigationIconButton(
                        icon: Icons.arrow_back_ios_rounded,
                        onTap: _selectedCardIndex > 0 ? () {
                          setState(() {
                            _selectedCardIndex--;
                            _pageController.animateToPage(
                              _selectedCardIndex,
                              duration: const Duration(milliseconds: 300),
                              curve: Curves.easeInOut,
                            );
                            _focusOnSelectedSchedule(schedules[_selectedCardIndex]);
                          });
                        } : null,
                      ),
                      
                      // Card indicator
                      Row(
                        children: List.generate(schedules.length, (index) => 
                          Container(
                            width: 8,
                            height: 8,
                            margin: const EdgeInsets.symmetric(horizontal: 2),
                            decoration: BoxDecoration(
                              shape: BoxShape.circle,
                              color: index == _selectedCardIndex ? greenColor : Colors.grey.withOpacity(0.3),
                            ),
                          )
                        ),
                      ),
                      
                      // Right navigation button
                      NavigationIconButton(
                        icon: Icons.arrow_forward_ios_rounded,
                        onTap: _selectedCardIndex < schedules.length - 1 && _selectedCardIndex != -1 ? () {
                          setState(() {
                            _selectedCardIndex++;
                            _pageController.animateToPage(
                              _selectedCardIndex,
                              duration: const Duration(milliseconds: 300),
                              curve: Curves.easeInOut,
                            );
                            _focusOnSelectedSchedule(schedules[_selectedCardIndex]);
                          });
                        } : null,
                      ),
                    ],
                  ),
                ),
                
                SizedBox(height: ResponsiveHelper.getResponsiveSpacing(context, 8)),
                
                // Schedule cards using reusable component
                SizedBox(
                  height: ResponsiveHelper.getResponsiveHeight(context, 140),
                  child: PageView.builder(
                    controller: _pageController,
                    itemCount: schedules.length,
                    onPageChanged: (index) {
                      setState(() {
                        _selectedCardIndex = index;
                        _focusOnSelectedSchedule(schedules[index]);
                      });
                    },
                    itemBuilder: (context, index) {
                      return ScheduleCard(
                        schedule: schedules[index],
                        onNavigate: () => _navigateToLocation(schedules[index]['coordinates'] as LatLng),
                      );
                    },
                  ),
                ),
              ],
            ],
          ),
        ),
      ],
    );
  }
}
            ],
          ),
        ),
        
        // Jadwal Content
        Expanded(
          child: RefreshIndicator(
            color: greenColor,
            onRefresh: _loadSchedules,
            child: _getFilteredSchedules().isEmpty
              ? _buildEmptyState()
              : ListView.builder(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  itemCount: _getFilteredSchedules().length,
                  itemBuilder: (context, index) {
                    // Mendapatkan data jadwal berdasarkan filter
                    final scheduleData = _getFilteredSchedules()[index];
                    return _buildScheduleCard(scheduleData);
                  },
                ),
          ),
        ),
      ],
    );
  }
  
  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.calendar_today_outlined,
            size: 80,
            color: Colors.grey.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'Tidak ada jadwal',
            style: blackTextStyle.copyWith(
              fontSize: 18,
              fontWeight: semiBold,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Belum ada jadwal pengambilan untuk kategori ini',
            textAlign: TextAlign.center,
            style: greyTextStyle.copyWith(
              fontSize: 14,
            ),
          ),
        ],
      ),
    );
  }
  
  // Mendapatkan jadwal berdasarkan filter yang dipilih
  List<Map<String, dynamic>> _getFilteredSchedules() {
    // Ini akan diganti dengan data dari API nanti
    // Untuk sementara kita gunakan data dummy
    final schedules = [
      {
        'time': '08:00 - 09:00',
        'customer_name': 'Wahyu Indra',
        'address': 'Jl. Muso Salim 8, Kota Samarinda, Kalimantan Timur',
        'waste_type': 'Anorganik',
        'waste_weight': '3 kg',
        'status': 'pending',
        'estimatedDistance': '3.2 km',
      },
      {
        'time': '09:30 - 10:30',
        'customer_name': 'Siti Rahayu',
        'address': 'Perumahan Indah Blok B, Kota Samarinda, Kalimantan Timur',
        'waste_type': 'Anorganik',
        'waste_weight': '1.5 kg',
        'status': 'completed',
        'estimatedDistance': '4.5 km',
      },
      {
        'time': '11:00 - 12:00',
        'customer_name': 'Ahmad Rizal',
        'address': 'Jl. Juanda No. 45, Kota Samarinda, Kalimantan Timur',
        'waste_type': 'Anorganik',
        'waste_weight': '3 kg',
        'status': 'in_progress',
        'estimatedDistance': '1.8 km',
      },
      {
        'time': '14:00 - 16:00',
        'customer_name': 'Wahyu Indra',
        'address': 'Jl. Muso Salim 8, Kota Samarinda, Kalimantan Timur',
        'waste_type': 'Organik',
        'waste_weight': '2 kg',
        'status': 'pending',
        'estimatedDistance': '3.2 km',
      },
      {
        'time': '17:00 - 18:00',
        'customer_name': 'Ahmad Rizal',
        'address': 'Jl. Juanda No. 45, Kota Samarinda, Kalimantan Timur',
        'waste_type': 'Anorganik',
        'waste_weight': '3 kg',
        'status': 'pending',
        'estimatedDistance': '2.7 km',
      },
    ];
    
    if (_selectedFilter == 'semua') {
      return schedules;
    } else {
      return schedules.where((s) => s['status'] == _selectedFilter).toList();
    }
  }
  
  Future<void> _selectDate(BuildContext context) async {
    final DateTime? pickedDate = await showDatePicker(
      context: context,
      initialDate: selectedDate,
      firstDate: DateTime.now().subtract(const Duration(days: 30)),
      lastDate: DateTime.now().add(const Duration(days: 30)),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: greenColor,
              onPrimary: whiteColor,
              onSurface: blackColor,
            ),
            textButtonTheme: TextButtonThemeData(
              style: TextButton.styleFrom(
                foregroundColor: greenColor,
              ),
            ),
          ),
          child: child!,
        );
      },
    );
    
    if (pickedDate != null && pickedDate != selectedDate) {
      setState(() {
        selectedDate = pickedDate;
        _loadSchedules(); // Reload schedules for selected date
      });
    }
  }

  // Widget untuk menampilkan kartu jadwal
  Widget _buildScheduleCard(Map<String, dynamic> schedule) {
    // Menentukan warna dan teks status berdasarkan status jadwal
    String statusText;
    Color statusColor;
    Color statusBgColor;

    switch (schedule['status']) {
      case 'completed':
        statusText = 'Selesai';
        statusColor = greenColor;
        statusBgColor = const Color(0xFFE3F6DF);
        break;
      case 'in_progress':
        statusText = 'Proses';
        statusColor = Colors.blue;
        statusBgColor = Colors.blue.withOpacity(0.1);
        break;
      default:
        statusText = 'Menunggu';
        statusColor = const Color(0xFFB58D00);
        statusBgColor = const Color(0xFFFFF8E0);
    }
    
    // Membuat tag untuk jenis sampah dan berat
    List<ScheduleTag> tags = [];
    
    // Tag untuk jenis sampah (waste_type)
    if (schedule['waste_type'] != null) {
      tags.add(
        ScheduleTag(
          label: schedule['waste_type'],
          backgroundColor: schedule['waste_type'] == 'Organik' 
              ? const Color(0xFFE3F6DF) // Hijau muda untuk organik
              : const Color(0xFFFFECE3), // Oranye muda untuk anorganik
          textColor: schedule['waste_type'] == 'Organik' 
              ? const Color(0xFF5CC488) // Hijau untuk organik
              : const Color(0xFFFF7A30), // Oranye untuk anorganik
        ),
      );
    }
    
    // Tag untuk berat sampah (waste_weight)
    if (schedule['waste_weight'] != null) {
      tags.add(
        ScheduleTag(
          label: schedule['waste_weight'],
          backgroundColor: Colors.grey.withOpacity(0.1),
          textColor: greyColor,
        ),
      );
    }
    
    return ScheduleCard(
      time: schedule['time'] ?? '',
      status: statusText,
      name: schedule['customer_name'] ?? '',
      address: schedule['address'] ?? '',
      tags: tags,
      statusColor: statusColor,
      statusBackgroundColor: statusBgColor,
      onTap: () {
        // Handle tap to view details
      },
    );
  }
}
